@page "/all-people"
@using System.ComponentModel.DataAnnotations
@inject HttpClient Http
@inject IJSRuntime JS


<h3>Catálogo de Personas</h3>

<button class="btn btn-primary mb-3" @onclick="AbrirModal">
    Registrar persona
</button>

<button class="btn btn-secondary mb-3 ms-2" @onclick="DescargarPdf">
    Descargar PDF
</button>

<!-- TABLA -->
<table class="table table-striped">
    <thead>
        <tr>
            <th>Nombre</th>
            <th>Edad</th>
            <th>Estatura</th>
            <th>Peso</th>
            <th>Descripción</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var p in personas)
        {
            <tr>
                <td>@p.Nombre</td>
                <td>@p.Edad</td>
                <td>@p.Estatura</td>
                <td>@p.Peso</td>
                <td>@p.Descripcion</td>
            </tr>
        }
    </tbody>
</table>

<!-- MODAL -->
@if (mostrarModal)
{
    <div class="modal-backdrop">
        <div class="modal-content">

            <h4>Registrar persona</h4>

            <EditForm Model="personaNueva" OnValidSubmit="GuardarPersona">
                <DataAnnotationsValidator />
                <ValidationSummary />

                <div class="mb-2">
                    <label>Nombre</label>
                    <InputText class="form-control" @bind-Value="personaNueva.Nombre" />
                </div>

                <div class="mb-2">
                    <label>Edad</label>
                    <InputNumber class="form-control" @bind-Value="personaNueva.Edad" />
                </div>

                <div class="mb-2">
                    <label>Estatura</label>
                    <InputNumber class="form-control" @bind-Value="personaNueva.Estatura" />
                </div>

                <div class="mb-2">
                    <label>Peso</label>
                    <InputNumber class="form-control" @bind-Value="personaNueva.Peso" />
                </div>

                <div class="mb-3">
                    <label>Descripción</label>
                    <InputTextArea class="form-control" @bind-Value="personaNueva.Descripcion" />
                </div>

                <button type="submit" class="btn btn-success">Guardar</button>
                <button type="button" class="btn btn-secondary ms-2" @onclick="CerrarModal">
                    Cancelar
                </button>
            </EditForm>

        </div>
    </div>
}

@code {

    async Task DescargarPdf()
    {
        var response = await Http.GetAsync("api/personas/export-pdf");

        if (!response.IsSuccessStatusCode)
            return;

        var bytes = await response.Content.ReadAsByteArrayAsync();

        var base64 = Convert.ToBase64String(bytes);

        await JS.InvokeVoidAsync(
            "downloadFile",
            "personas.pdf",
            "application/pdf",
            base64
        );
    }


    List<Persona> personas = new();

    bool mostrarModal = false;

    Persona personaNueva = new();

    protected override async Task OnInitializedAsync()
    {
        personas = await Http.GetFromJsonAsync<List<Persona>>("api/personas")
                   ?? new List<Persona>();
    }

    void AbrirModal()
    {
        personaNueva = new Persona();
        mostrarModal = true;
    }

    void CerrarModal()
    {
        mostrarModal = false;
    }

    async Task GuardarPersona()
    {
        await Http.PostAsJsonAsync("api/personas", personaNueva);

        personas = await Http.GetFromJsonAsync<List<Persona>>("api/personas")
                    ?? new List<Persona>();

        mostrarModal = false;
    }


    public class Persona
    {
        public int Id { get; set; }

        [Required]
        public string Nombre { get; set; } = string.Empty;

        [Required]
        public int Edad { get; set; }

        [Required]
        public double Estatura { get; set; }

        [Required]
        public double Peso { get; set; }

        [Required]
        public string Descripcion { get; set; } = string.Empty;
    }

}
